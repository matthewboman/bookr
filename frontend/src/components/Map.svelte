<script lang="ts">
    import { LeafletMap, Marker, Popup, TileLayer } from 'svelte-leafletjs'
    import type { LatLngExpression } from "leaflet"

    import ContactPopup       from './ContactPopup.svelte'
    import { get }            from '../api'
    import type { Contact }   from '../types'
    import { contactReviews, selectedContact } from '../store'
    import Reviews from './Reviews.svelte';

    export let renderedContacts: Contact[]

    const REVIEWS_URL = "/reviews?contactId="
    const mapOptions = {
        center: [ 37.09, -90.71 ] as LatLngExpression,
        zoom:   4,
    }
    const tileUrl = "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png"
    const tileLayerOptions = {
        minZoom: 0,
        maxZoom: 20,
        maxNativeZoom: 19,
        attribution: "Â© OpenStreetMap contributors",
    }

    let leafletMap

    async function showReviews(contact: Contact) {
        // TODO: Clear existing
        $contactReviews  = []
        $selectedContact = {}

        console.log('hmm')

        let res = await get(`${REVIEWS_URL}${contact.contactId}`)
            .then(r => r.json())

        $contactReviews  = res.reviews // intentionally overwrite
        $selectedContact = contact // intentionally overwrite
    }
</script>

<LeafletMap bind:this={leafletMap} options={mapOptions}>
    <TileLayer url={tileUrl} options={tileLayerOptions}/>
    {#each renderedContacts as contact}
        <Marker latLng={[contact.latitude, contact.longitude]} events={['click']} on:click={() => showReviews(contact)}>
            <Popup>
                <ContactPopup contact={contact}/>
            </Popup>
        </Marker>
    {/each}
</LeafletMap>

